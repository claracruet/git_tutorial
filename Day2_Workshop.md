# Marker Development Workshop – Day 2  
### Practical Session: Marker Development with **panGenomeBreedr**

---

## 1 Load Required Libraries

```r
# --- Load libraries ---
library(panGenomeBreedr)   # main package for pangenome-based marker design
library(googledrive)       # not required if working from your local computer for file handling if working from Google Drive

```

## 2 Set Working Directory

Adjust this path to your own Google Drive or local folder.
```r
# --- Setting working directory ---
wd <- "~/Google Drive/My Drive/Clara lab folder/Labworkshops/Marker_Design/"
setwd(wd)
```

## 3 Downloading reference genome

#### Note: SKIP this step if you already have it in your computer
```r
# --- Downloading reference genome --- 
# This creates a full file path inside your current working directory
destfile <- file.path(getwd(), "Sbicolor_730_v5.0.fa.gz")

# --- Download the genome file only if it’s not already present --- 
# This prevents re-downloading every time the code is re-run
if (!file.exists(destfile)) {
  download.file(
    url      = "https://drive.google.com/uc?export=download&id=1vA18H5XkvG6FabUAmgXTaWdw2ixNu6QL",
    destfile = destfile,
    mode     = "wb"   # write in binary mode (required for .gz files, especially on Windows)
  )
}

# --- Get the absolute path to the downloaded genome file --- 
genome_file <- normalizePath(destfile)

# --- Print a confirmation message showing where the file was saved --- 
cat("Genome available at:", genome_file, "\n")
```


## 3 Define Input Files and Parameters

Before running the design function, specify the key input files and parameters. 

#### Note: If you didn't download the reference genome in the step before, edit "genome_file" to the correct path

```r
# --- Path to reference genome in FASTA format (.fa or .fa.gz) ---
genome_file <- destfile

# --- Select to the VCF file containing the variants of interest ---
vcf_file <- file.choose()

# --- Marker ID for the target variant (must match an entry in the VCF) ---
marker_ID <- "SNP_Chr03_11361160"

# --- Optional: assign a region or gene name for reference ---
region_name <- "Test_Marker"

# --- Minor Allele Frequency threshold (0–1) --- 
maf <- 0.02

# --- Temporary path to save plot for the alignment --- 
path <- tempdir() # (default directory for saving alignment outputs)


```

## 4 Running the kasp_marker_desgin function

#### Note: change the "marker_design_output" to the desired variable name
```r
# --- Running kasp_marker_design ----
marker_design_output <- panGenomeBreedr::kasp_marker_design(
  # Editable parameters, we set them up above  
  vcf_file     = vcf_file,
  genome_file  = genome_file,
  marker_ID    = marker_ID,
  region_name  = region_name,
  maf          = maf,
  
  # Required column names in the VCF, if you are using a VCF, do not edit these 
  variant_id_col = "ID",
  chrom_col      = "CHROM",
  pos_col        = "POS",
  ref_al_col     = "REF",
  alt_al_col     = "ALT",
  
  # Output configuration 
  save_alignment = TRUE,  # saves FASTA alignment for the marker
  plot_file      = path     # saves alignment plot to working directory
)
```


## 5 Looking at the  panGenomeBreedr::kasp_marker_design() output
```r
# --- Looking at the kasp_marker_design() data frame ----
View(marker_design_output$marker_data)

# --- View marker alignment output from temp folder ----
path3 <- file.path(path, list.files(path = path, "alignment_"))
system(paste0('open "', path3, '"')) # Open PDF file from R
on.exit(unlink(path)) # Clear the temp directory on exit 
```
### Opens the variable in a Rstudio tab
<img width="1312" height="816" alt="image" src="https://github.com/user-attachments/assets/08daa336-d26d-488f-afbf-87109e0b9cae" />

```r
# ---  View marker alignment output from the temporary folder ---

# Find the path to the alignment PDF that was generated by the function.
path3 <- file.path(path, list.files(path = path, "alignment_"))

# Open the alignment PDF directly from R (macOS & most Linux systems)
# On Windows, replace 'open' with 'start' if needed.
system(paste0('open "', path3, '"'))

# Clean up: delete the temporary directory when the R session exits
on.exit(unlink(path))

```
### Opens the pdf file
<img width="1311" height="724" alt="image" src="https://github.com/user-attachments/assets/5ee499b8-7509-443c-b9ba-8575de13eb99" />


## 6 Formatting the output for the Intertek form
```r
# --- Loading function to reformat to Intertek Table ---
source("https://gist.githubusercontent.com/claracruet/4f473a104314e1a0cf9dd937a3a99c19/raw/90021d8a6861893356037cb4c4bfc731660c2da8/make_intertek_table.R")

# --- Running the Intertek formatting function ---

# This step reformats the marker data (from 'marker_design_output') into the standardized
# Intertek submission table used for marker ordering.
intertek_table <- make_intertek_table(
  marker_data    = marker_design_output,        # Output object from kasp_marker_design()
  genome_version = "Sb5.1",                     # Reference genome version used for marker naming
  region_name    = "Example",                   # Region or gene name associated with the marker
  trait          = "Uknown",                    # Target trait for which the marker was developed
  owner          = "Morris"                     # Name or organization submitting the marker
  # publication_status is optional (defaults to "Restricted")
)

# --- Getting copy/paste ready for the intertek form ---
cat(paste(intertek_table[1, ], collapse = "\t"), "\n")

# --- Opening the table if you prefer to copy/paste by column ---
intertek_table
```
### The needed information will be outputed to the console, you can copy paste it directly as it appears in the console
<img width="657" height="398" alt="image" src="https://github.com/user-attachments/assets/54b833b0-e5dd-4d67-adee-592baff44cc0" />

### The needed information will be outputed to the console, you can copy paste it by elements
<img width="1309" height="819" alt="image" src="https://github.com/user-attachments/assets/ffd23ec0-a762-423b-9054-d6c038cdfab9" />
